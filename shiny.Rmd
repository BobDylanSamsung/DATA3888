---
title: "Untitled"
author: "Zhantao Shi"
date: "`r Sys.Date()`"
output: html_document
---
```{r setup}
## Cox Model Shiny App (app.R)
# Load required libraries
library(shiny)
library(survival)
library(glmnet)
library(survminer)
library(ggplot2)
library(dplyr)
library(tidyr)
library(GEOquery) 
## Cox Model Shiny App (app.R)

#--------------------------------------------------------
# Global: Data loading, preprocessing, model fitting
#--------------------------------------------------------
```

```{r getdata}
extract_gene_symbol <- function(gene_assignment) {
  parts <- strsplit(gene_assignment, " // ")[[1]]
  if (length(parts) >= 2) trimws(parts[2]) else NA
}
extract_gse_data <- function(gse) {
  list(featureData = fData(gse), phenoData = pData(gse), eMat = exprs(gse))
}

# Fetch and prepare GEO data
GSE28735_raw <- getGEO("GSE28735")$GSE28735_series_matrix.txt.gz %>% extract_gse_data()
GSE62452_raw <- getGEO("GSE62452")$GSE62452_series_matrix.txt.gz %>% extract_gse_data()
common_genes <- intersect(rownames(GSE28735_raw$eMat), rownames(GSE62452_raw$eMat))
expr_combined <- cbind(
  GSE28735_raw$eMat[common_genes, ],
  GSE62452_raw$eMat[common_genes, ]
)

# Phenotype processing
pheno287 <- GSE28735_raw$phenoData %>%
  mutate(is_dead = as.numeric(replace(`cancer_death:ch1`, `cancer_death:ch1` == "na", NA))) %>%
  filter(!grepl("non-tumor tissue", source_name_ch1) & !is.na(is_dead)) %>%
  rename(time = `survival_month:ch1`)

pheno624 <- GSE62452_raw$phenoData %>%
  mutate(is_dead = as.numeric(replace(`survival status:ch1`, `survival status:ch1` %in% c("na","?"), NA))) %>%
  filter(grepl("Pancreatic tumor", `tissue:ch1`) & !is.na(is_dead)) %>%
  rename(time = `survival months:ch1`)

pheno <- bind_rows(pheno287, pheno624)
expr_mat <- expr_combined[, colnames(expr_combined) %in% rownames(pheno)]

# Remove a row for each is_dead for later use
dead_0_sample <- rownames(pheno)[pheno$is_dead == 0][1]
dead_1_sample <- rownames(pheno)[pheno$is_dead == 1][1]
expr_0 <- expr_mat[, dead_0_sample, drop = FALSE]
expr_1 <- expr_mat[, dead_1_sample, drop = FALSE]
write.csv(expr_0, file = "predict_test_dead0.csv")
write.csv(expr_1, file = "predict_test_dead1.csv")

exclude_samples <- c(dead_0_sample, dead_1_sample)
pheno <- pheno[!rownames(pheno) %in% exclude_samples, ]
expr_mat <- expr_mat[, !colnames(expr_mat) %in% exclude_samples]
```

```{r model}
# Survival object and expression matrix
surv_obj <- with(pheno, Surv(as.numeric(time), is_dead))
X <- t(expr_mat) %>% as.matrix()
# Lasso-Cox for feature selection
set.seed(3888)
cvfit <- cv.glmnet(X, surv_obj, family = "cox", alpha = 1)
best_lambda <- cvfit$lambda.min
lasso_model <- glmnet(X, surv_obj, family = "cox", alpha = 1, lambda = best_lambda)
gene_coefs <- data.frame(
  gene = colnames(X)[coef(lasso_model)@i + 1],
  coef = coef(lasso_model)@x
)
selected_genes <- gene_coefs$gene
# Refit unpenalized CoxPH on selected genes
train_df <- data.frame(
  time   = as.numeric(pheno$time),
  status = as.numeric(pheno$is_dead),
  as.data.frame(X[, selected_genes, drop = FALSE])
)
colnames(train_df)[3:ncol(train_df)] <- selected_genes
coxph_model <- coxph(Surv(time, status) ~ ., data = train_df)
# 训练集上风险评分与分组阈值
train_lp <- predict(coxph_model, newdata = train_df, type = "lp")
cutoff <- median(train_lp, na.rm = TRUE)
```

```{r shiny}
#--------------------------------------------------------
# UI Definition
#--------------------------------------------------------
ui <- fluidPage(
  titlePanel("Survival prediction Shiny App Based on Lasso-Cox"),
  sidebarLayout(
    sidebarPanel(
      h4("Input the genetic table of the new patient"),
      fileInput("gene_csv", "Upload CSV of genes", accept = ".csv"),
      actionButton("predict", "Start Predict"),
      width = 3
    ),
    mainPanel(
      tabsetPanel(
        tabPanel("Predict Outcome",
          # Model plots (shown before prediction)
          conditionalPanel(
            "output.show_model_plots == true",
            plotOutput("lambda_plot"),
            plotOutput("coef_plot")
          ),
          # Prediction outputs (shown after prediction)
          conditionalPanel(
            "output.show_model_plots == false",
            verbatimTextOutput("risk_text"),
            verbatimTextOutput("group_text"),
            verbatimTextOutput("hr_text"),
            verbatimTextOutput("median_text"),
            tableOutput("prob_table"),
            plotOutput("pred_plot")
          )
        )
      ), width = 9
    )
  )
)

#--------------------------------------------------------
# Server Logic
#--------------------------------------------------------
server <- function(input, output, session) {
  # For controlling UI
  # changes to true when prediction is made. Renders model plots or prediction plots
  pred_made <- reactiveVal(FALSE)  
  output$show_model_plots <- reactive({ !pred_made() })
  outputOptions(output, "show_model_plots", suspendWhenHidden = FALSE)
  
  # MODEL PLOTS
  output$lambda_plot <- renderPlot({
    plot(cvfit, main = "Cross-validation for Penalized Cox Model")
  })
  output$coef_plot <- renderPlot({
    ggplot(gene_coefs, aes(x = reorder(gene, coef), y = coef, fill = coef > 0)) +
      geom_col() +
      coord_flip() +
      scale_fill_manual(values = c("red", "blue"),
                       labels = c("high-risk gene","protective gene")) +
      labs(x = NULL, y = "coef", title = "Lasso-Cox gene id") +
      theme_minimal()
  })

  observeEvent(input$predict, {
    req(input$gene_csv)
    pred_made(TRUE)
    
    df <- read.csv(input$gene_csv$datapath, header = FALSE, stringsAsFactors = FALSE)
  
    #The first row contains patientID header info — remove that row
    df <- df[-1, , drop = FALSE]
    
    genes <- df[[1]]               # first column = gene names
    values <- as.numeric(df[[2]])  # second column = numeric values
    names(values) <- genes         # associate each value to its gene name
    
    newdata <- as.data.frame(t(values[selected_genes]))
    colnames(newdata) <- selected_genes
  
    # PREDICT USING CSV DF
    risk_score <- predict(coxph_model, newdata = newdata, type = "lp")
    risk_group <- ifelse(risk_score > cutoff, "High", "Low")
    hr <- exp(risk_score)
    fit_new <- survfit(coxph_model, newdata = newdata)
  
    output$risk_text <- renderText({ paste0("Risk Score: ", round(risk_score, 3)) })
    output$group_text <- renderText({ paste0("Risk Group(High/Low): ", risk_group) })
    output$hr_text <- renderText({ paste0("(Hazard ratio): ", round(hr, 3)) })
    output$median_text <- renderText({
      idx <- which.min(abs(fit_new$surv - 0.5))
      med_time <- round(fit_new$time[idx], 1)
      paste0("Predict the median survival time: ", med_time, " Month")
    })
    output$prob_table <- renderTable({
      times <- c(6, 12, 24, 36)
      surv_summary <- summary(fit_new, times = times)
      data.frame(
        Month = surv_summary$time,
        Survival_Prob = round(surv_summary$surv, 3)
      )
    })
  })
}

# Launch the app
shinyApp(ui = ui, server = server)

```


