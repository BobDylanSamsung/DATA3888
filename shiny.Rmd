---
title: "Untitled"
author: "Zhantao Shi"
date: "`r Sys.Date()`"
output: html_document
---
```{r setup}
## Cox Model Shiny App (app.R)
# Load required libraries
library(shiny)
library(survival)
library(glmnet)
library(survminer)
library(ggplot2)
library(dplyr)
library(tidyr)
library(GEOquery) 
## Cox Model Shiny App (app.R)

#--------------------------------------------------------
# Global: Data loading, preprocessing, model fitting
#--------------------------------------------------------
```

```{r getdata}
extract_gene_symbol <- function(gene_assignment) {
  parts <- strsplit(gene_assignment, " // ")[[1]]
  if (length(parts) >= 2) trimws(parts[2]) else NA
}
extract_gse_data <- function(gse) {
  list(featureData = fData(gse), phenoData = pData(gse), eMat = exprs(gse))
}

# Fetch and prepare GEO data
GSE28735_raw <- getGEO("GSE28735")$GSE28735_series_matrix.txt.gz %>% extract_gse_data()
GSE62452_raw <- getGEO("GSE62452")$GSE62452_series_matrix.txt.gz %>% extract_gse_data()
common_genes <- intersect(rownames(GSE28735_raw$eMat), rownames(GSE62452_raw$eMat))
expr_combined <- cbind(
  GSE28735_raw$eMat[common_genes, ],
  GSE62452_raw$eMat[common_genes, ]
)

# Phenotype processing
pheno287 <- GSE28735_raw$phenoData %>%
  mutate(is_dead = as.numeric(replace(`cancer_death:ch1`, `cancer_death:ch1` == "na", NA))) %>%
  filter(!grepl("non-tumor tissue", source_name_ch1) & !is.na(is_dead)) %>%
  rename(time = `survival_month:ch1`)

pheno624 <- GSE62452_raw$phenoData %>%
  mutate(is_dead = as.numeric(replace(`survival status:ch1`, `survival status:ch1` %in% c("na","?"), NA))) %>%
  filter(grepl("Pancreatic tumor", `tissue:ch1`) & !is.na(is_dead)) %>%
  rename(time = `survival months:ch1`)

pheno <- bind_rows(pheno287, pheno624)
expr_mat <- expr_combined[, colnames(expr_combined) %in% rownames(pheno)]

# Remove a row for each is_dead for later use
dead_0_sample <- rownames(pheno)[pheno$is_dead == 0][1]
dead_1_sample <- rownames(pheno)[pheno$is_dead == 1][1]
expr_0 <- expr_mat[, dead_0_sample, drop = FALSE]
expr_1 <- expr_mat[, dead_1_sample, drop = FALSE]
write.csv(expr_0, file = "predict_test_dead0.csv")
write.csv(expr_1, file = "predict_test_dead1.csv")

exclude_samples <- c(dead_0_sample, dead_1_sample)
pheno <- pheno[!rownames(pheno) %in% exclude_samples, ]
expr_mat <- expr_mat[, !colnames(expr_mat) %in% exclude_samples]
```

```{r model}
# Survival object and expression matrix
surv_obj <- with(pheno, Surv(as.numeric(time), is_dead))
X <- t(expr_mat) %>% as.matrix()
# Lasso-Cox for feature selection
set.seed(3888)
cvfit <- cv.glmnet(X, surv_obj, family = "cox", alpha = 1)
best_lambda <- cvfit$lambda.min
lasso_model <- glmnet(X, surv_obj, family = "cox", alpha = 1, lambda = best_lambda)
gene_coefs <- data.frame(
  gene = colnames(X)[coef(lasso_model)@i + 1],
  coef = coef(lasso_model)@x
)
selected_genes <- gene_coefs$gene
# Refit unpenalized CoxPH on selected genes
train_df <- data.frame(
  time   = as.numeric(pheno$time),
  status = as.numeric(pheno$is_dead),
  as.data.frame(X[, selected_genes, drop = FALSE])
)
colnames(train_df)[3:ncol(train_df)] <- selected_genes
coxph_model <- coxph(Surv(time, status) ~ ., data = train_df)
# 训练集上风险评分与分组阈值
train_lp <- predict(coxph_model, newdata = train_df, type = "lp")
cutoff <- median(train_lp, na.rm = TRUE)
```

```{r define_text_and_outputs}
lambda_expl <- HTML('
  <b>Horizontal axis:</b> Log(λ). When λ gets larger (to the left), the penalty becomes stronger and the model becomes more sparse. When λ gets smaller (to the right), the penalty becomes weaker and more genes are kept.<br>
  <b>Vertical axis:</b> Partial Likelihood Deviance. A smaller value means the model fits better.<br>
  Each red dot shows the average deviance for a λ value. The gray lines show the range of error across folds.<br>
  The left dashed line shows λ.min, where the error is the smallest. The right dashed line shows λ.1se.<br>
  We chose λ.min for our model (see below).<br>
')

coef_expl <- HTML('
  The absolute value of each gene\'s coefficient reflects its contribution to the risk score: the larger the value, the more important for distinguishing prognosis.<br>
  <span style="color:blue"><b>Blue bars</b></span> indicate protective genes (negative coefficient): higher expression, lower risk.<br>
  <span style="color:red"><b>Red bars</b></span> indicate high-risk genes (positive coefficient): higher expression, higher risk.<br>
')

km_expl <- HTML('
  Risk grouping: Patients were divided into "low-risk group" (red) and "high-risk group" (cyan) based on the median risk score of all samples. <br>
  Kaplan–Meier curve: The horizontal axis shows follow-up time (months), and the vertical axis shows survival probability.<br>
  The red curve stays above the cyan curve at all times, indicating that patients in the low-risk group have a much higher survival rate compared to those in the high-risk group.<br>
  Log-rank test p-value: p < 0.0001, showing that the difference between the two survival curves is statistically highly significant. This means that the risk score based on the 29 selected genes can clearly distinguish between good and poor prognosis.<br>
  Risk table (Number at risk): Shown below the curves, it displays the number of patients still under follow-up at each time point, helping to evaluate the reliability of survival estimates in later stages.
')

# ----------------------------------------------------------
# Output rendering functions for use in server()
# ----------------------------------------------------------

# Lambda cross-validation plot
lambda_plot_output <- function(cvfit) {
  renderPlot({
    plot(cvfit, main = "Cross-validation for Penalized Cox Model")
  })
}

# Lambda summary text
lambda_summary_output <- function(best_lambda, gene_coefs) {
  renderText({
    paste0(
      "Best λ by cross-validation (λ.min): ", signif(best_lambda, 5), ". ",
      "This value selected ", nrow(gene_coefs), " predictors (genes) for the final model."
    )
  })
}

# Lasso-Cox gene coefficients barplot
coef_plot_output <- function(gene_coefs) {
  renderPlot({
    ggplot(gene_coefs, aes(x = reorder(gene, coef), y = coef, fill = coef > 0)) +
      geom_col() +
      coord_flip() +
      scale_fill_manual(values = c("red", "blue"),
                       labels = c("high-risk gene", "protective gene")) +
      labs(x = NULL, y = "Coefficient", title = "Lasso-Cox gene coefficients") +
      theme_minimal()
  })
}

# Number of selected gene summary
n_selected_genes_output <- function(gene_coefs) {
  renderText({
    ng <- nrow(gene_coefs)
    paste0("After training, a total of ", ng, " genes were selected. ",
           "The model has ", sum(gene_coefs$coef > 0), " high-risk (positive) and ",
           sum(gene_coefs$coef < 0), " protective (negative) genes."
    )
  })
}

# Kaplan-Meier survival plot for model
model_km_plot_output <- function(fit_km, train_df) {
  renderPlot({
    survminer::ggsurvplot(fit_km, data = train_df, pval = TRUE, risk.table = TRUE,
                          palette = c("red", "cyan"),
                          title = "Kaplan-Meier Survival Curves by Risk Group")
  })
}

# Single patient predicted KM plot
pred_plot_output <- function(pred_result) {
  renderPlot({
    req(pred_result$fit_new)
    plot(pred_result$fit_new,
         xlab = "Months",
         ylab = "Predicted survival probability",
         main = "Patient's Predicted Survival Curve",
         col = "blue", lwd = 2)
    abline(h = 0.5, col = "red", lty = 2)
  })
}

# Patient risk score on cohort histogram
pred_risk_hist_output <- function(train_lp, pred_result) {
  renderPlot({
    req(pred_result$risk_score)
    hist(train_lp, breaks = 30, xlab = "Risk score",
         main = "Risk score distribution (cohort)", col = "lightgray")
    abline(v = as.numeric(pred_result$risk_score), col = "red", lwd = 3)
    legend("topright", legend = "This patient", col = "red", lwd = 2)
  })
}

# Patient-specific outputs
risk_text_output <- function(pred_result) {
  renderText({
    req(pred_result$risk_score)
    paste0("Risk Score: ", round(pred_result$risk_score, 3))
  })
}

group_text_output <- function(pred_result) {
  renderText({
    req(pred_result$risk_group)
    paste0("Risk Group (High/Low): ", pred_result$risk_group)
  })
}

hr_text_output <- function(pred_result) {
  renderText({
    req(pred_result$hr)
    paste0("Hazard ratio: ", round(pred_result$hr, 3))
  })
}

median_text_output <- function(pred_result) {
  renderText({
    req(pred_result$fit_new)
    idx <- which.min(abs(pred_result$fit_new$surv - 0.5))
    med_time <- round(pred_result$fit_new$time[idx], 1)
    paste0("Predicted median survival time: ", med_time, " months")
  })
}

prob_table_output <- function(pred_result) {
  renderTable({
    req(pred_result$fit_new)
    times <- c(6, 12, 24, 36)
    surv_summary <- summary(pred_result$fit_new, times = times)
    data.frame(
      Month = surv_summary$time,
      Survival_Prob = round(surv_summary$surv, 3)
    )
  })
}

# Function to attach all output renderings in one call
attach_render_outputs <- function(output, 
                                 cvfit, 
                                 best_lambda, 
                                 gene_coefs, 
                                 fit_km, 
                                 train_df, 
                                 train_lp, 
                                 pred_result) {
  # Model tab outputs
  output$lambda_plot      <- lambda_plot_output(cvfit)
  output$lambda_summary   <- lambda_summary_output(best_lambda, gene_coefs)
  output$coef_plot        <- coef_plot_output(gene_coefs)
  output$n_selected_genes <- n_selected_genes_output(gene_coefs)
  output$model_km_plot    <- model_km_plot_output(fit_km, train_df)

  # Prediction tab outputs
  output$pred_plot        <- pred_plot_output(pred_result)
  output$pred_risk_hist   <- pred_risk_hist_output(train_lp, pred_result)
  output$risk_text        <- risk_text_output(pred_result)
  output$group_text       <- group_text_output(pred_result)
  output$hr_text          <- hr_text_output(pred_result)
  output$median_text      <- median_text_output(pred_result)
  output$prob_table       <- prob_table_output(pred_result)
  
  invisible(output) # for chaining, or simply return output if you wish
}
```

```{r shiny}
#--------------------------------------------------------
# UI Definition
#--------------------------------------------------------
ui <- fluidPage(
  titlePanel("Survival prediction Shiny App Based on Lasso-Cox"),
  sidebarLayout(
    sidebarPanel(
      h4("Input the genetic table of the new patient"),
      fileInput("gene_csv", "Upload CSV of genes", accept = ".csv"),
      actionButton("predict", "Start Predict"),
      width = 3
    ),
    mainPanel(
      tabsetPanel(
        id="main_tabs",
        tabPanel("Model", 
                 # Lambda plot, explanations, and stats
                 h4("Lambda Cross-Validation Plot"),
                 tags$div(
                   tags$a(
                     "Show explanation",
                     href = "#",
                     `data-toggle` = "collapse",
                     `data-target` = "#lambda-expl",
                     class = "btn btn-link"
                   ),
                   tags$div(
                     id = "lambda-expl",
                     class = "collapse",
                     lambda_expl
                   )
                 ),
                 plotOutput("lambda_plot"),
                 textOutput("lambda_summary"),

                 tags$hr(),

                 # Coefficient plot, explanation, and stats
                 h4("Lasso-Cox Gene Coefficients"),
                 tags$div(
                   tags$a(
                     "Show explanation",
                     href = "#",
                     `data-toggle` = "collapse",
                     `data-target` = "#coef-expl",
                     class = "btn btn-link"
                   ),
                   tags$div(
                     id = "coef-expl",
                     class = "collapse",
                     coef_expl
                   )
                 ),
                 plotOutput("coef_plot"),
                 textOutput("n_selected_genes"),
                 # Kaplan-Meier Survival Curves by Risk Group Plot
                  h4("Kaplan-Meier Survival Curves by Risk Group"),
                  tags$div(
                    tags$a(
                      "Show explanation",
                      href = "#",
                      `data-toggle` = "collapse",
                      `data-target` = "#km-expl",
                      class = "btn btn-link"
                    ),
                    tags$div(
                      id = "km-expl",
                      class = "collapse",
                      km_expl
                    )
                  ),
                plotOutput("model_km_plot"),
        ),
        tabPanel("Prediction", 
          conditionalPanel(
            "output.show_model_plots == false",
            verbatimTextOutput("risk_text"),
            verbatimTextOutput("group_text"),
            verbatimTextOutput("hr_text"),
            verbatimTextOutput("median_text"),
            tableOutput("prob_table"),
            plotOutput("pred_plot"),
            plotOutput("pred_risk_hist")   
          )
        )
      ), width = 9
    )
  )
)

#--------------------------------------------------------
# Server Logic
#--------------------------------------------------------
server <- function(input, output, session) {
  pred_result <- reactiveValues()
  # Flag for whether we are showing the model or prediction
  pred_made <- reactiveVal(FALSE)
  output$show_model_plots <- reactive({ !pred_made() })
  outputOptions(output, "show_model_plots", suspendWhenHidden = FALSE)
  
  attach_render_outputs(
    output,
    cvfit      = cvfit,
    best_lambda= best_lambda,
    gene_coefs = gene_coefs,
    fit_km     = fit_km,
    train_df   = train_df,
    train_lp   = train_lp,
    pred_result= pred_result
  )


  observeEvent(input$predict, {
    req(input$gene_csv)
    pred_made(TRUE)
    updateTabsetPanel(session, "main_tabs", selected = "Prediction")
    df <- read.csv(input$gene_csv$datapath, header = FALSE, stringsAsFactors = FALSE)
  
    # Remove CSV header row
    df <- df[-1, , drop = FALSE]
    genes <- df[[1]]
    values <- as.numeric(df[[2]])
    names(values) <- genes
    
    newdata <- as.data.frame(t(values[selected_genes]))
    colnames(newdata) <- selected_genes
  
    # Predict
    # PREDICTION
    pred_result$risk_score <- predict(coxph_model, newdata = newdata, type = "lp")
    pred_result$risk_group <- ifelse(pred_result$risk_score > cutoff, "High", "Low")
    pred_result$hr <- exp(pred_result$risk_score)
    pred_result$fit_new <- survfit(coxph_model, newdata = newdata)
    pred_result$newdata <- newdata 
  })

  # Reset to model plots if file re-uploaded
  observeEvent(input$gene_csv, pred_made(FALSE))
}

# Launch the app
shinyApp(ui = ui, server = server)

```


