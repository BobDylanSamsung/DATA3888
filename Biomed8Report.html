<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Biomed8 Group Report</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Biomed8Report_files/libs/clipboard/clipboard.min.js"></script>
<script src="Biomed8Report_files/libs/quarto-html/quarto.js"></script>
<script src="Biomed8Report_files/libs/quarto-html/popper.min.js"></script>
<script src="Biomed8Report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Biomed8Report_files/libs/quarto-html/anchor.min.js"></script>
<link href="Biomed8Report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Biomed8Report_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Biomed8Report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Biomed8Report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Biomed8Report_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Biomed8 Group Report</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="executive-summary" class="level2">
<h2 class="anchored" data-anchor-id="executive-summary">Executive Summary</h2>
<p>Improved prognostic tools are needed to guide the treatment of pancreatic cancer, which has one of the highest mortality rates in the world. (University of Utah Health, 2019) This project addresses this hurdle by using gene expression data to develop a personalised survival prediction tool for clinicians’s use. Our approach utilises Gene Expression Omnibus datasets, which are publicly available, to identify biomarkers and develop a robust predictive model for pathologists.</p>
<p>Our main findings were the identification of select significant genes from an initial pool of over 28,000 genes using a minimum depth Random Forest. The selected genes were most predictive of survival in cancer patients. Subsequently, a CoxBoost model was trained and optimised on the selected features through hyperparameter tuning. Model performance was evaluated using an independent test set and measured primarily by the integrated Brier score (IBS). The concordance index, also known as the C-index and the time-dependent area under the ROC curve, was also used.</p>
<p>This analysis holds practical relevance in its potential to increase the efficiency of clinicians. It involves risk stratification by providing personalised and interpretable patient survival predictions. The model output includes risk scores, risk groups, estimated survival probability over time, and identifies which genes contribute most significantly to risk predictions. A comprehensive shiny app was also developed to enable ease of use, allowing users to input CSV files and receive a personalised risk assessment.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/fig1.jpeg" class="img-fluid figure-img"></p>
<figcaption>Figure 1: Flowchart diagram outlining the entire project pipeline from processing data to predicting survival results</figcaption>
</figure>
</div>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">1. Background</h2>
<p>Infamous amongst cancers for its commonly late diagnosis and poor survival prognosis, there is a crucial need for improved tools to predict outcomes and support personalised treatment for pancreatic cancer patients. Gene expression profiling has emerged as a promising approach for identifying biomarkers that can help guide clinical decisions for treatment and care (Newhook et al., 2014). However, the dimensionality of gene expression data poses a significant analytical hurdle. The risks include overfitting, a heavy computational load, and difficulty in interpreting the results.</p>
<p>This project aimed to develop a robust survival prediction model using gene expression data from tumorous tissue samples. The goal was to improve patient care by generating interpretable insights for pathologists, clinicians and researchers from high-dimensional gene expression data using machine learning techniques. The resulting Shiny app was specifically designed to provide pathologists with an intuitive and practical tool to support decision-making in cancer prognosis and patient management.</p>
<p>Data for this project was sourced from the Gene Expression Omnibus (GEO), a public repository containing data for various outlets of research. Based on a 2023 study by Posta and Győrffy two datasets were selected, GSE28735, GSE62452, containing 45 and 69 tumour samples respectively. Using the R package GEOquery, the data was loaded, phenotype data cleaned and standardised to unify survival endpoints and filtered to retain tumour samples with complete follow-up. Expression matrices were merged by intersecting genes, yielding a combined dataset of 105 samples and 28,000+genes. A holdout set of four samples was reserved for external validation, while the remaining data was partitioned to ensure robust model training, testing and validation.</p>
<p>The CoxBoost model was chosen for this report due to its ability to handle high dimensional data. CoxBoost is a survival analysis approach that combines componentwise likelihood based boosting with Cox proportional hazards regression. Boosting is an iterative modelling strategy that continuously adds simple models to gradually correct the errors or deficiencies generated in the previous iteration, thereby continuously improving prediction accuracy. Specifically, in each iteration, the direction for the next optimisation is determined based on the deficiencies of the current model. Then, a new model is trained to make up for these deficiencies, ultimately forming an overall model with better comprehensive performance (Simon et al., 2011).</p>
<p>CoxBoost precisely combines this boosting strategy with Cox regression. It can not only handle the right deletion problem in survival data very well, but also deal with the common modelling instability problem in high-dimensional data. Compared with the traditional Cox regression, CoxBoost can maintain good stability and predictive performance even when the number of variables is much greater than the number of samples (Bair et al., 2006).</p>
</section>
<section id="method" class="level2">
<h2 class="anchored" data-anchor-id="method">2. Method</h2>
<p>This project encompassed multiple stages, beginning with data preprocessing and exploratory data analysis. Subsequently, feature selection was conducted alongside the development and hyperparameter tuning of survival prediction models. Following the construction of a preliminary model, rigorous evaluation was performed using a range of performance metrics. Finally, the refined model was deployed as an interactive Shiny web application, providing a user-friendly platform to demonstrate the final product. All analyses were conducted in R, leveraging a diverse suite of CRAN and Bioconductor packages.</p>
<section id="data-preprocessing" class="level3">
<h3 class="anchored" data-anchor-id="data-preprocessing">2.1 Data Preprocessing</h3>
<p>Gene expression and clinical data for the datasets were loaded into the R Studio environment through the GEOquery R package. The datasets contained data on pancreatic cancer samples, including the gene expression values, as well as clinical phenotype information regarding the patients. The first step taken was to align our phenotype data for uniformity across the datasets, Specifically the outcome variables event status (is_dead) and survival time (months_survived) and non-tumour samples were removed, ensuring that only tumour samples with complete survival status information were retained. This step was important to enable merging and consistency of data between the two datasets.</p>
<p>Following standardisation, the cleaned gene expression matrices from both datasets were merged based on shared gene symbol identifiers to create a unified dataset. Expression values were log-transformed and viewed to confirm normalised consistency. Finally, the combined dataset was partitioned into training (60%), validation (20%), and test (20%) sets using stratified sampling to maintain balanced proportions and unbiased model evaluation. This stratified sampling method was used to maintain unbiased model evaluation and validate that the model performed well on new, unseen gene expression profiles from patients.</p>
</section>
<section id="exploratory-data-analysis" class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis">2.2 Exploratory Data Analysis</h3>
<p>To better understand the structure of the datasets, summary statistics, including mean, median and quantiles were calculated for each gene’s expression data across all samples. This was then used to visualise the data and identify potential outliers. Principal Component Analysis (PCA) was performed on the transposed expression matrix to visualise clustering of classes, as it helps reduce dimensionality while retaining the linear combination of variables with the highest variance. To further explore and understand the data, a heatmap of the 75 most variable genes was generated, with samples annotated by survival status to investigate patterns that might be associated with survival status outcomes. The output from the heatmap allowed for visual inspection of whether certain genes exhibited differential expression correlating with survival status.&nbsp;</p>
<p>Additionally, the limma package was used to compare gene expression between deceased and surviving patients. The results were summarised in a volcano plot highlighting the spread of genes based on statistical significance, thereby aiding in the identification of relevant genes for our survival predictions.</p>
</section>
<section id="feature-selection" class="level3">
<h3 class="anchored" data-anchor-id="feature-selection">2.3 Feature Selection</h3>
<p>Due to the high dimensionality of gene expression data, feature selection is often required to optimise machine learning. These datasets were no exception, with over 30,000 gene expression features, despite relatively few samples. To address this, a minimal-depth random survival forest was employed to identify the most significant genes as recommended by Posta and Győrffy (2023). Minimal depth measures the depth at which a specific gene is first used within a decision tree split. Genes that congregate closer to the top levels of the tree are seen as more important for predictions (Seifert, Gundlach, &amp; Szymczak, 2019). The genes were ranked based on their allocated minimal depth scores, and the top 15 genes were selected accordingly. This significantly reduced the feature space, eliminating many noisy features, and hence facilitated a faster and more efficient subsequent modelling process.</p>
</section>
<section id="coxboost-model-development" class="level3">
<h3 class="anchored" data-anchor-id="coxboost-model-development">2.4 CoxBoost Model Development</h3>
<p>To optimise model performance, a comprehensive grid search was conducted over two key hyperparameters; penalty and step size. The penalty value affects the regularisation applied to the parameter vector in each boosting step to prevent overfitting and ranged from 0 to 50 in increments of 5. Meanwhile, the stepsize affects the size of each boosting step after a covariate has been selected and took the values of 0.1, 0.3, 0.5, 0.7 and 1.0.</p>
<p>The final model was selected based on the hyperparameter set that achieved the best performance on the test set and then evaluated on a held-out validation set to assess its generalizability. The performance was assessed using two key survival analysis metrics:</p>
<p><strong>Integrated Brier Score (IBS)</strong>: The IBS reflects the average squared difference between the predicted survival probability and the actual outcome for each individual over time. Lower values indicate better calibration and accuracy of the survival probability estimates for individual patients.</p>
<p><strong>Concordance Index (C-index)</strong>: The C-index measures the probability that, when comparing two patients, the model correctly identifies the one with the higher risk of an adverse event. Higher values indicate stronger discriminative power between pairs of patients.</p>
<p>Specifically Integrated Brier Score was minimised whilst choosing a suitably high concordance index.</p>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">3. Results</h2>
<section id="model-performance-metrics" class="level3">
<h3 class="anchored" data-anchor-id="model-performance-metrics">3.1 Model Performance Metrics</h3>
<p>While both metrics provide valuable insights, greater emphasis was placed on the IBS score as it aligned more closely with our project’s goal of delivering accurate survival probability estimates over time, rather than simply ranking patients relative to each other. This focus on calibration and accuracy was especially relevant for our target users, pathologists, who require precise survival probability estimates to inform patient care. After running the hyperparameter grid search, the penalty value of 15 and stepsize of 0.3 were chosen by hand and found that 7 was the optimal number of boosting steps.</p>
<p>The CoxBoost survival model demonstrated excellent predictive performance in multiple evaluation indicators. The Brier score does not exceed 0.25 at any timepoint with an IBS of 0.144, indicating that the predicted probability of the model aligns closely with the actual outcome and has a high calibration accuracy. Further, It achieved a test set C-index of 0.722 indicating a strong discriminative ability, and offering a valuable tool for precision medicine.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/AUC_plot.png" class="img-fluid figure-img"></p>
<figcaption>Figure 2: Time dependent area under the Receiver Operating Characteristic curve</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/km_survival_plot.png" class="img-fluid figure-img"></p>
<figcaption>Figure 3: Kaplan-Meier survival curves for high and low risk groups with a p-value less than 0.05 indicating significant difference</figcaption>
</figure>
</div>
<p>As shown in the figures above, the time-dependent AUC indicates that the model has a high discriminative ability between high and low risk groups at different follow-up time points. Although it slightly decreases over time, it still remains at an high level overall. The Kaplan-Meier survival curve further verified the effectiveness of the model in stratifying patients’ risks, exhibiting a significant difference in survival rate between the high and low-risk groups (p = 0.047). Together, these highlight the models strong discriminative ability and practical value in survival prediction and risk assessment, thus providing support for individualised clinical treatment.</p>
<p>In the feature importance analysis, genes such as AGRN and PRDM16 have the greatest impact on the model prediction results. Among them, AGRN is associated with a poor prognosis, while PRDM16 shows a protective effect, suggesting its potential biological significance in the survival of patients. Several of the selected genes have also been previously implicated in cancer-related pathways, further supporting the biological interpretability of the model (Wang et al, 2025; He et al, 2020). Genes with 0 coefficients were selected in the random survival forest but ultimately contributed no additional predictive value during boosting, indicating low marginal effect.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/feature_importance_coxboost.png" class="img-fluid figure-img"></p>
<figcaption>Figure 4: Features selected by minimum depth random forest and their coefficients in the CoxBoost model</figcaption>
</figure>
</div>
</section>
<section id="interactive-prediction-with-shiny-application" class="level3">
<h3 class="anchored" data-anchor-id="interactive-prediction-with-shiny-application">3.2 Interactive Prediction with Shiny Application</h3>
<p>The developed Shiny application provides a user-friendly interface for deploying the trained CoxBoost model. Functionality is divided into 4 tabs. The home tab contains general information on the group, including links to the GitHub repository and the datasets used. The EDA tab contains visualisations on trends in the data without a specific focus on the implemented CoxBoost model. The model tab contains the key performance metrics used to assess the models predictive capability. Finally, the predict tab allows clinicians or researchers to upload gene expression data for a new patient (in the form of a CSV file with gene IDs and expression values) and produces personalised survival predictions. The output includes a quantitative risk score, classification into a high- or low-risk group, an estimated median survival, identification of the key genes contributing to the patient’s risk profile and the ability to get the predicted probability of survival at a specific timepoint. This tool translates the complex modelling pipeline into an accessible format for potential research or illustrative clinical use.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/app_screenshot.png" class="img-fluid figure-img"></p>
<figcaption>Figure 5: Model page in Shiny application</figcaption>
</figure>
</div>
</section>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">4. Discussion</h2>
<section id="model-selection" class="level3">
<h3 class="anchored" data-anchor-id="model-selection">4.1 Model selection</h3>
<p>The ultimate goal of this study was to predict patient survival time using gene expression data. However, two major challenges were encountered during the model selection process. Firstly, the dataset contained nearly 30,000 gene variables, resulting in extremely high dimensionality. Additionally, the survival data was right-censored, meaning that some patients were still alive at the end of the follow-up period, so it was only known that they survived up to a certain point rather than their exact survival time.&nbsp;</p>
<p>In the context of such high-dimensional and right-censored data, traditional methods such as Principal Component Analysis (PCA) and Penalised Cox, the model initially implemented, can easily lead to overfitting. Furthermore, processing such high-dimensional data could also result in a large computational burden(Salerno &amp; Li, 2022). To address these issues, based on a 2020 study by Spooner et al, the alternative approach of a CoxBoost model was deemed most suitable to ensure predictive accuracy and reduce the risk of overfitting.</p>
</section>
<section id="limitations" class="level3">
<h3 class="anchored" data-anchor-id="limitations">4.2 Limitations</h3>
<p>Whilst the model demonstrates promising predictive capabilities, there are several limitations to acknowledge. From a biomedical perspective, retrospective datasets can introduce biases related to patient selection. The combined sample size was also relatively small, limiting the statistical power and running the risk of overfitting despite our validation techniques employed. Furthermore, the datasets might not be reflective of the diverse pancreatic cancer population, restricting the generalisability of our findings. The lack of covariates such as cancer stage, gender and age may mean that our model has not picked up on some crucial survival indicators, limiting its predictive capability.</p>
<p>It is also important to note that the gene expression data used in this study are static snapshots recorded at a point in time, and are unable to capture the dynamic and progressive nature of tumour cells as patients progress through pancreatic cancer. This limitation restricts the model’s ability to adapt to changes in gene expression associated with treatment response or tumour evolution, which are critical factors for prognosis.</p>
<p>Another limitation lies in the quality and completeness of clinical annotations accompanying the gene expression data. Many public datasets, including those used in this study, often lack comprehensive and standardised clinical metadata such as treatment regimens, comorbidities, and long-term follow-up outcomes. This scarcity of detailed contextual information may limit the model’s ability to adjust for confounding factors, thereby affecting the accuracy and clinical relevance of the survival predictions.</p>
</section>
<section id="future-work" class="level3">
<h3 class="anchored" data-anchor-id="future-work">4.3 Future Work</h3>
<p>These limitations can be addressed by future research or studies undertaken. From a clinical standpoint, improving robustness and generalisability of the CoxBoost model and feature selection in larger cohorts is necessary. Complementary data such as imaging data of the tumour samples, blood tissue data or covariates like tumour stage and gender, could enhance the predictive framework and improve accuracy and precision.&nbsp;</p>
<p>From a data science viewpoint, sophisticated modelling approaches such as ensemble methods, deep learning, time-varying or dynamic survival models may be able to more accurately recreate the fluid and nonlinear interactions present in pancreatic cancer biology. The interpretability of individual predictions could be improved by implementing certain modern AI techniques like SHAP or LIME, which could increase clinician confidence in the predictions made by the model. Better batch effect correction strategies may reduce the technical biases from the integration of data from multiple sources.&nbsp;</p>
<p>Future improvements to the Shiny application could enhance its usability and analytical capabilities. From an accessibility perspective, an enhanced user interface, including tool tips and guided walkthroughs, could improve usability, particularly for non-technical users. Furthermore, a particularly valuable extension would be to enable the simultaneous upload of multiple CSV files to compare expressions and predicted probabilities between individuals or cohorts. This could be done through visualisations such as an overlaid or mirrored radar chart. Overall, these additions would support more interactive exploration and comparative analysis, broadening the application’s clinical and research utility.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">5. Conclusion</h2>
<p>In conclusion, this project developed a reproducible data exploration into survival analysis. It used Random Survival Forest-based feature selection with CoxBoost survival modelling to generate a deployed model based on significant gene expressions for pancreatic cancer. The model demonstrated strong predictive performance in the given independent test data and was deployed as an interactive Shiny application for stakeholders. While limitations relating to data uniformity, sample size, and model assumptions exist, this project provides a solid foundation for future efforts in pancreatic cancer research. This work marks a starting point for further improvements to predictive modelling for cancer and further exploration of the biological importance of the identified gene expressions.</p>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">6. Appendix</h2>
<section id="student-contributions" class="level3">
<h3 class="anchored" data-anchor-id="student-contributions">6.1 Student Contributions</h3>
<section id="dylan-herdan" class="level4">
<h4 class="anchored" data-anchor-id="dylan-herdan">6.1.1 Dylan Herdan</h4>
<p>Dylan was primarily responsible for implementation of the Shiny app. This included server logic (eg CSV uploads and prediction handling) as well as the UI (layout, tab structure, visualisations). He led early data exploration, transitioned from the Penalised Cox to the CoxBoost model and implemented feature selection and hyperparameter tuning. Dylan also integrated code from other team members into a cohesive pipeline and helped collate, edit, finalise and submit the final report.</p>
</section>
<section id="jaijun-zhao" class="level4">
<h4 class="anchored" data-anchor-id="jaijun-zhao">6.1.2 Jaijun Zhao</h4>
<p>Jiajun contributed to drafting the report, focusing on model evaluation using C-index and cross-validation. He also provided feedback on model selection and summarised model performance in the slides, linking it to the Shiny app. and ensuring a clear transition to the Shiny application demonstration.</p>
</section>
<section id="shuhan-chen" class="level4">
<h4 class="anchored" data-anchor-id="shuhan-chen">6.1.3 Shuhan Chen</h4>
<p>Shuhan contributed to the project’s analytical depth by performing more extensive Exploratory Data Analysis (EDA), including generating key visualisations like PCA plots and heatmaps. Shuhan was responsible for implementing the data splitting strategy for training and testing sets and calculating the confusion matrix for model performance assessment. Shuhan also played a role in drafting and editing sections of the final report.</p>
</section>
<section id="cherry-fan" class="level4">
<h4 class="anchored" data-anchor-id="cherry-fan">6.1.4 Cherry Fan</h4>
<p>Cherry contributed to the initial exploratory data analysis (EDA), preparing key insights and visualisations that informed subsequent modelling decisions. She created and refined presentation slides to effectively communicate the project’s findings and methodologies. Additionally, Cherry assisted with the editing and finalisation of the project report, ensuring clarity and cohesion in both technical and narrative elements.</p>
</section>
<section id="ashley-wang" class="level4">
<h4 class="anchored" data-anchor-id="ashley-wang">6.1.5 Ashley Wang</h4>
<p>Ashley helped to write the draft and edit the report, as well as provide feedback on sections written by other members of the group. She helped to find preliminary datasets that were potential candidates for this project, as well as investigating survival analysis on R. She was also responsible for assisting with the exploratory data analysis, including combining the datasets and performing some basic data collection cleaning, visualisations and interpretations.&nbsp;</p>
</section>
<section id="zhantao-shi" class="level4">
<h4 class="anchored" data-anchor-id="zhantao-shi">6.1.6 Zhantao Shi</h4>
<p>Zhantao was responsible for the survival analysis modelling section of the report. He assisted in training models using R, including the Penalised Cox model, and provided detailed textual explanations for the charts presented in the Shiny app.</p>
</section>
</section>
<section id="bibliography" class="level3">
<h3 class="anchored" data-anchor-id="bibliography">6.2 Bibliography</h3>
<p>University of Utah Health. (2019, March 12). Why is pancreatic cancer so deadly? University of Utah Health.<a href="https://healthcare.utah.edu/healthfeed/2019/03/why-pancreatic-cancer-so-deadly" class="uri">https://healthcare.utah.edu/healthfeed/2019/03/why-pancreatic-cancer-so-deadly</a></p>
<p>Newhook, T. E., Blais, E. M., Lindberg, J. M., Adair, S. J., Xin, W., Lee, J. K., Papin, J. A., Parsons, J. T., &amp; Bauer, T. W. (2014). A thirteen-gene expression signature predicts survival of patients with pancreatic cancer and identifies new genes of interest. PloS one, 9(9), e105631</p>
<p>Stephan Seifert, Sven Gundlach, Silke Szymczak, Surrogate minimal depth as an importance measure for variables in random forests, Bioinformatics, Volume 35, Issue 19, October 2019, Pages 3663–3671, <a href="https://doi.org/10.1093/bioinformatics/btz149" class="uri">https://doi.org/10.1093/bioinformatics/btz149</a></p>
<p>Simon, N., Friedman, J., Hastie, T., &amp; Tibshirani, R. (2011). Regularization paths for Cox’s proportional Hazards model via Coordinate Descent. Journal of Statistical Software, 39(5). https://doi.org/10.18637/jss.v039.i05</p>
<p>Bair, E., Hastie, T., Paul, D., &amp; Tibshirani, R. (2006). Prediction by supervised principal components. Journal of the American Statistical Association, 101(473), 119–137. <a href="https://doi.org/10.1198/016214505000000628" class="uri">https://doi.org/10.1198/016214505000000628</a>&nbsp;</p>
<p>Salerno, S., &amp; Li, Y. (2022). High-Dimensional survival Analysis: methods and applications. Annual Review of Statistics and Its Application, 10(1), 25–49. <a href="https://doi.org/10.1146/annurev-statistics-032921-022127" class="uri">https://doi.org/10.1146/annurev-statistics-032921-022127</a></p>
<p>Spooner, A., Chen, E., Sowmya, A. et al.&nbsp;A comparison of machine learning methods for survival analysis of high-dimensional clinical data for dementia prediction. Sci Rep 10, 20410 (2020). <a href="https://doi.org/10.1038/s41598-020-77220-w" class="uri">https://doi.org/10.1038/s41598-020-77220-w</a>&nbsp;</p>
<p>He, Z., Yang, C., He, Y., Gong, B., Yin, C., Feng, J., Chen, L., Tang, J., &amp; Chen, Y. (2020). CAMTA1, a novel antitumor gene, regulates proliferation and the cell cycle in glioma by inhibiting AKT phosphorylation. Cellular Signalling, 79, 109882. <a href="https://doi.org/10.1016/j.cellsig.2020.109882" class="uri">https://doi.org/10.1016/j.cellsig.2020.109882</a></p>
<p>Wang, Y., Zheng, S., Gao, H., Wang, Y., Chen, Y., &amp; Han, A. (2025). DNA methylation-induced suppression of PRDM16 in colorectal cancer metastasis through the PPARγ/EMT pathway. Cellular Signalling, 111634. <a href="https://doi.org/10.1016/j.cellsig.2025.111634" class="uri">https://doi.org/10.1016/j.cellsig.2025.111634</a></p>
<p>Posta M, Győrffy B. (2023). Analysis of a large cohort of pancreatic cancer transcriptomic profiles to reveal the strongest prognostic factors. Clin Transl Sci. <a href="https://doi.org/10.1111/cts.13563" class="uri">https://doi.org/10.1111/cts.13563</a></p>
</section>
<section id="code" class="level3">
<h3 class="anchored" data-anchor-id="code">6.3 Code</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract useful data from GEO object</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>extract_gse_data <span class="ot">&lt;-</span> <span class="cf">function</span>(gse) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">featureData =</span> <span class="fu">fData</span>(gse),</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">phenoData =</span> <span class="fu">pData</span>(gse),</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">eMat =</span> <span class="fu">exprs</span>(gse)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust GEO downloader</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>get_geo_data <span class="ot">&lt;-</span> <span class="cf">function</span>(gse_id, <span class="at">destdir =</span> <span class="fu">tempdir</span>(), <span class="at">retries =</span> <span class="dv">5</span>) {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"[INFO]: Attempting to load"</span>, gse_id))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>retries) {</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>      gse_list <span class="ot">&lt;-</span> <span class="fu">getGEO</span>(gse_id, <span class="at">destdir =</span> destdir, <span class="at">GSEMatrix =</span> <span class="cn">TRUE</span>, <span class="at">AnnotGPL =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>      gse <span class="ot">&lt;-</span> gse_list[[<span class="dv">1</span>]]</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(gse)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"[INFO]: Attempt"</span>, i, <span class="st">"failed for"</span>, gse_id, <span class="st">":"</span>, e<span class="sc">$</span>message))</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (i <span class="sc">&lt;</span> retries) <span class="fu">Sys.sleep</span>(<span class="dv">3</span>) <span class="cf">else</span> <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">"Failed to download"</span>, gse_id))</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 1: Load GEO datasets ---</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>download_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"GEO_data"</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(download_dir)) <span class="fu">dir.create</span>(download_dir)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>GSE28735 <span class="ot">&lt;-</span> <span class="fu">get_geo_data</span>(<span class="st">"GSE28735"</span>, <span class="at">destdir =</span> download_dir) <span class="sc">%&gt;%</span> <span class="fu">extract_gse_data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[INFO]: Attempting to load GSE28735</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Found 1 file(s)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>GSE28735_series_matrix.txt.gz</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Using locally cached version: C:/Users/dylan/Documents/DATA3888/GEO_data/GSE28735_series_matrix.txt.gz</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Using locally cached version of GPL6244 found here:
C:/Users/dylan/Documents/DATA3888/GEO_data/GPL6244.soft.gz </code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>GSE62452 <span class="ot">&lt;-</span> <span class="fu">get_geo_data</span>(<span class="st">"GSE62452"</span>, <span class="at">destdir =</span> download_dir) <span class="sc">%&gt;%</span> <span class="fu">extract_gse_data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[INFO]: Attempting to load GSE62452</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Found 1 file(s)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>GSE62452_series_matrix.txt.gz</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Using locally cached version: C:/Users/dylan/Documents/DATA3888/GEO_data/GSE62452_series_matrix.txt.gz</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Using locally cached version of GPL6244 found here:
C:/Users/dylan/Documents/DATA3888/GEO_data/GPL6244.soft.gz </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 2: Clean phenotype data ---</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>pheno287 <span class="ot">&lt;-</span> GSE28735<span class="sc">$</span>phenoData <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_dead =</span> <span class="fu">as.numeric</span>(<span class="fu">replace</span>(<span class="st">`</span><span class="at">cancer_death:ch1</span><span class="st">`</span>, <span class="st">`</span><span class="at">cancer_death:ch1</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"na"</span>, <span class="cn">NA</span>)),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">months_survived =</span> <span class="fu">as.numeric</span>(<span class="fu">replace</span>(<span class="st">`</span><span class="at">survival_month:ch1</span><span class="st">`</span>, <span class="st">`</span><span class="at">survival_month:ch1</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"na"</span>, <span class="cn">NA</span>))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"non-tumor tissue"</span>, source_name_ch1) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(is_dead))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>pheno624 <span class="ot">&lt;-</span> GSE62452<span class="sc">$</span>phenoData <span class="sc">%&gt;%</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_dead =</span> <span class="fu">as.numeric</span>(<span class="fu">replace</span>(<span class="st">`</span><span class="at">survival status:ch1</span><span class="st">`</span>, <span class="st">`</span><span class="at">survival status:ch1</span><span class="st">`</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"na"</span>,<span class="st">"?"</span>), <span class="cn">NA</span>)),</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">months_survived =</span> <span class="fu">as.numeric</span>(<span class="fu">replace</span>(<span class="st">`</span><span class="at">survival months:ch1</span><span class="st">`</span>, <span class="st">`</span><span class="at">survival months:ch1</span><span class="st">`</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"na"</span>,<span class="st">"?"</span>), <span class="cn">NA</span>))</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"Pancreatic tumor"</span>, <span class="st">`</span><span class="at">tissue:ch1</span><span class="st">`</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(is_dead))</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine phenotype</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pheno287, pheno624)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 3: Combine expression data ---</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>common_genes <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">rownames</span>(GSE28735<span class="sc">$</span>eMat), <span class="fu">rownames</span>(GSE62452<span class="sc">$</span>eMat))</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>subset_eMat_GSE28735 <span class="ot">&lt;-</span> GSE28735<span class="sc">$</span>eMat[common_genes, ]</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>subset_eMat_GSE62452 <span class="ot">&lt;-</span> GSE62452<span class="sc">$</span>eMat[common_genes, ]</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>combined_matrix <span class="ot">&lt;-</span> <span class="fu">cbind</span>(subset_eMat_GSE28735, subset_eMat_GSE62452)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Step 4: Save validation samples and remove them from training data ---</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>selected_ids <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"GSM1527137"</span>, <span class="st">"GSM1527230"</span>, <span class="st">"GSM711944"</span>, <span class="st">"GSM711984"</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Save selected samples to CSV</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>outdir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"patient_data"</span>)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(outdir)) <span class="fu">dir.create</span>(outdir)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (sample_id <span class="cf">in</span> selected_ids) {</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>  expr_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_id    =</span> <span class="fu">rownames</span>(combined_matrix),</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">expression =</span> combined_matrix[, sample_id]</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  ph <span class="ot">&lt;-</span> pheno[sample_id, ]</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>  expr_df<span class="sc">$</span>is_dead         <span class="ot">&lt;-</span> ph<span class="sc">$</span>is_dead</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>  expr_df<span class="sc">$</span>months_survived <span class="ot">&lt;-</span> ph<span class="sc">$</span>months_survived</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(expr_df, <span class="at">file =</span> <span class="fu">file.path</span>(outdir, <span class="fu">paste0</span>(sample_id,<span class="st">"is_dead_"</span>, ph<span class="sc">$</span>is_dead, <span class="st">".csv"</span>)),</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>            <span class="at">row.names =</span> <span class="cn">FALSE</span>, <span class="at">quote =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove validation samples</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> pheno[<span class="sc">!</span><span class="fu">rownames</span>(pheno) <span class="sc">%in%</span> selected_ids, ]</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>combined_matrix <span class="ot">&lt;-</span> combined_matrix[, <span class="fu">colnames</span>(combined_matrix) <span class="sc">%in%</span> <span class="fu">rownames</span>(pheno)]</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Final check</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">colnames</span>(combined_matrix) <span class="sc">==</span> <span class="fu">rownames</span>(pheno)))</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Final object</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>gse <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">featureData =</span> GSE28735<span class="sc">$</span>featureData,</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">phenoData =</span> pheno,</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">eMat =</span> combined_matrix</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying summary function across samples</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>summary_values_eda <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">as.vector</span>(gse<span class="sc">$</span>eMat))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>summary_per_sample_eda <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">apply</span>(gse<span class="sc">$</span>eMat, <span class="dv">2</span>, summary)))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set SampleID as a column (not using rownames to avoid duplication)</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>summary_per_sample_eda<span class="sc">$</span>SampleID <span class="ot">&lt;-</span> <span class="fu">rownames</span>(summary_per_sample_eda)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(summary_per_sample_eda) <span class="ot">&lt;-</span> <span class="cn">NULL</span>  <span class="co"># Remove rownames to prevent duplication</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>summary_per_sample_eda <span class="ot">&lt;-</span> summary_per_sample_eda <span class="sc">%&gt;%</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Min =</span> <span class="st">"Min."</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q1 =</span> <span class="st">"1st Qu."</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Median =</span> <span class="st">"Median"</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="st">"Mean"</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q3 =</span> <span class="st">"3rd Qu."</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Max =</span> <span class="st">"Max."</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(SampleID, Min, Q1, Median, Mean, Q3, Max)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>summary_long_eda <span class="ot">&lt;-</span> summary_per_sample_eda <span class="sc">%&gt;%</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"Min"</span>, <span class="st">"Q1"</span>, <span class="st">"Median"</span>, <span class="st">"Mean"</span>, <span class="st">"Q3"</span>, <span class="st">"Max"</span>), <span class="at">names_to =</span> <span class="st">"Statistic"</span>, <span class="at">values_to =</span> <span class="st">"Value"</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA Setup - using survival status instead of tissue</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>gse<span class="sc">$</span>phenoData<span class="sc">$</span>Survival_Status <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(gse<span class="sc">$</span>phenoData<span class="sc">$</span>is_dead <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"Alive"</span>, <span class="st">"Deceased"</span>),</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alive"</span>, <span class="st">"Deceased"</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>pca_all <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(<span class="fu">t</span>(gse<span class="sc">$</span>eMat), <span class="at">scale. =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Heatmap Data Preparation </span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>var_genes_eda <span class="ot">&lt;-</span> <span class="fu">apply</span>(gse<span class="sc">$</span>eMat, <span class="dv">1</span>, var)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>top75_genes_eda <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">sort</span>(var_genes_eda, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">75</span>])</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>annotation_col_eda <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Survival =</span> gse<span class="sc">$</span>phenoData<span class="sc">$</span>Survival_Status)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(annotation_col_eda) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(gse<span class="sc">$</span>phenoData)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for survival time distribution</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>prepare_survival_time_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a dataframe with survival time and status</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  survival_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">SampleID =</span> <span class="fu">rownames</span>(gse<span class="sc">$</span>phenoData),</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">SurvivalTime =</span> gse<span class="sc">$</span>phenoData<span class="sc">$</span>months_survived, </span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">Status =</span> <span class="fu">factor</span>(</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(gse<span class="sc">$</span>phenoData<span class="sc">$</span>is_dead <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"Alive"</span>, <span class="st">"Deceased"</span>),</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alive"</span>, <span class="st">"Deceased"</span>)</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(survival_data)</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for volcano plot - differential expression between alive/deceased</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>prepare_volcano_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create design matrix</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>  design <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>gse<span class="sc">$</span>phenoData<span class="sc">$</span>is_dead)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(design) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Intercept"</span>, <span class="st">"Deceased_vs_Alive"</span>)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit linear model</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> limma<span class="sc">::</span><span class="fu">lmFit</span>(gse<span class="sc">$</span>eMat, design)</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> limma<span class="sc">::</span><span class="fu">eBayes</span>(fit)</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get results</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> limma<span class="sc">::</span><span class="fu">topTable</span>(fit, <span class="at">coef =</span> <span class="st">"Deceased_vs_Alive"</span>, <span class="at">number =</span> <span class="cn">Inf</span>)</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add gene names</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>GeneID <span class="ot">&lt;-</span> <span class="fu">rownames</span>(results)</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Flag significant genes (adjust threshold as needed)</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>Significant <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(results<span class="sc">$</span>adj.P.Val <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"Yes"</span>, <span class="st">"No"</span>)</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>  results<span class="sc">$</span>Label <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(results<span class="sc">$</span>Significant <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(results<span class="sc">$</span>logFC) <span class="sc">&gt;</span> <span class="dv">1</span>, results<span class="sc">$</span>GeneID, <span class="st">""</span>)</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>survival_time_data <span class="ot">&lt;-</span> <span class="fu">prepare_survival_time_data</span>()</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>volcano_data <span class="ot">&lt;-</span> <span class="fu">prepare_volcano_data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct survival object with survival time and event status</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>surv_obj <span class="ot">&lt;-</span> <span class="fu">with</span>(gse<span class="sc">$</span>phenoData, <span class="fu">Surv</span>(<span class="fu">as.numeric</span>(months_survived), <span class="fu">as.numeric</span>(is_dead)))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare feature matrix</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">t</span>(gse<span class="sc">$</span>eMat) <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>train_idx <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(<span class="fu">factor</span>(gse<span class="sc">$</span>phenoData<span class="sc">$</span>is_dead), <span class="at">p =</span> <span class="fl">0.80</span>, <span class="at">list =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>safe_names <span class="ot">&lt;-</span> <span class="fu">make.names</span>(<span class="fu">colnames</span>(X), <span class="at">unique =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> safe_names</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>lookup <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">safe =</span> safe_names,              <span class="co"># length 28869</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">raw  =</span> <span class="fu">rownames</span>(gse<span class="sc">$</span>eMat),      <span class="co"># length 28869</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Split into training and testing sets</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">&lt;-</span> X[train_idx, ]</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>X_test  <span class="ot">&lt;-</span> X[<span class="sc">-</span>train_idx, ]</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Survival objects for training/testing sets</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>train_surv <span class="ot">&lt;-</span> surv_obj[train_idx]</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>test_surv <span class="ot">&lt;-</span> surv_obj[<span class="sc">-</span>train_idx]</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataframes for training and testing</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>train_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">time    =</span> <span class="fu">as.numeric</span>(gse<span class="sc">$</span>phenoData<span class="sc">$</span>months_survived[train_idx]),</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">is_dead =</span> <span class="fu">as.numeric</span>(gse<span class="sc">$</span>phenoData<span class="sc">$</span>is_dead[train_idx]),</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(X_train, <span class="at">check.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>test_df  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">time    =</span> <span class="fu">as.numeric</span>(gse<span class="sc">$</span>phenoData<span class="sc">$</span>months_survived[<span class="sc">-</span>train_idx]),</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">is_dead =</span> <span class="fu">as.numeric</span>(gse<span class="sc">$</span>phenoData<span class="sc">$</span>is_dead[<span class="sc">-</span>train_idx]),</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(X_test , <span class="at">check.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Run Random Survival Forest for feature selection</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>rsf_model <span class="ot">&lt;-</span> <span class="fu">rfsrc</span>(<span class="fu">Surv</span>(time, is_dead) <span class="sc">~</span> ., <span class="at">data =</span> train_df, </span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ntree =</span> <span class="dv">1000</span>, </span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>                   <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Get variable importance by minimal depth</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>var_imp <span class="ot">&lt;-</span> <span class="fu">var.select</span>(rsf_model, <span class="at">method =</span> <span class="st">"md"</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>top_by_md <span class="ot">&lt;-</span> var_imp<span class="sc">$</span>md.obj<span class="sc">$</span>topvars          <span class="co"># may be character(0)</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(top_by_md) <span class="sc">==</span> <span class="dv">0</span>) {                <span class="co"># fall-back: use VIMP</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>  vimp_sorted <span class="ot">&lt;-</span> <span class="fu">sort</span>(rsf_model<span class="sc">$</span>importance,</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>                      <span class="at">decreasing =</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.last   =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>  top_by_md <span class="ot">&lt;-</span> <span class="fu">names</span>(vimp_sorted)</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>n_features_to_select <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>selected_features <span class="ot">&lt;-</span> top_by_md[<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(n_features_to_select,</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">length</span>(top_by_md))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for CoxBoost with selected features only</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>X_train_selected <span class="ot">&lt;-</span> X_train[, selected_features, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>X_test_selected <span class="ot">&lt;-</span> X_test[, selected_features, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># STANDARDIZATION STEP</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>X_train_selected_std <span class="ot">&lt;-</span> <span class="fu">scale</span>(X_train_selected)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>X_test_selected_std <span class="ot">&lt;-</span> <span class="fu">scale</span>(X_test_selected, </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">center =</span> <span class="fu">attr</span>(X_train_selected_std, <span class="st">"scaled:center"</span>),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">scale =</span> <span class="fu">attr</span>(X_train_selected_std, <span class="st">"scaled:scale"</span>))</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up CoxBoost - note it requires time and status separately</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>train_time <span class="ot">&lt;-</span> train_df<span class="sc">$</span>time</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>train_is_dead <span class="ot">&lt;-</span> train_df<span class="sc">$</span>is_dead  </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>test_time <span class="ot">&lt;-</span> test_df<span class="sc">$</span>time</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>test_is_dead <span class="ot">&lt;-</span> test_df<span class="sc">$</span>is_dead    </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># hyperparams from hptune.rmd chosen by min ibs score</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>penalty_val <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>stepsize <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross validate to find optimal number of boosting steps</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>cv_res <span class="ot">&lt;-</span> <span class="fu">cv.CoxBoost</span>(</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">time      =</span> train_time,</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">status    =</span> train_is_dead,</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">x         =</span> X_train_selected_std,</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxstepno =</span> <span class="dv">100</span>,</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">K         =</span> <span class="dv">10</span>,</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty   =</span> penalty_val,</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">stepsize.factor =</span> stepsize,</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">unpen.index =</span> <span class="cn">NULL</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a><span class="co"># extract optimal steps</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>optimal_steps <span class="ot">&lt;-</span> cv_res<span class="sc">$</span>optimal.step</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit final CoxBoost model with the same penalty</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>coxboost_model <span class="ot">&lt;-</span> <span class="fu">CoxBoost</span>(</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">time      =</span> train_time,</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">status    =</span> train_is_dead,</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">x         =</span> X_train_selected_std,</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">stepno    =</span> optimal_steps,</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">stepsize.factor =</span> stepsize,</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty   =</span> penalty_val,</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">unpen.index =</span> <span class="cn">NULL</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="co"># linear predictor for the training data</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>lp_train <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(coxboost_model,</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">newdata =</span> X_train_selected_std,</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">type    =</span> <span class="st">"lp"</span>,</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>          <span class="at">at.step =</span> optimal_steps)   <span class="co"># &lt;- returns a vector</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a><span class="co"># data frame that will be fed to coxph()</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>df_train <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">time   =</span> train_time,</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">status =</span> train_is_dead,</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">lp     =</span> lp_train       </span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a><span class="co"># "null" Cox model </span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>coxph_base <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, status) <span class="sc">~</span> <span class="fu">offset</span>(lp),   </span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">data   =</span> df_train,</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"breslow"</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>bh <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(coxph_base, <span class="at">centered =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>coxboost_model<span class="sc">$</span>bh_time   <span class="ot">&lt;-</span> bh<span class="sc">$</span>time</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>coxboost_model<span class="sc">$</span>bh_hazard <span class="ot">&lt;-</span> bh<span class="sc">$</span>hazard</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>coxboost_model<span class="sc">$</span>stepno <span class="ot">&lt;-</span> optimal_steps</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict on test set</span></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>risk_scores_test <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(coxboost_model,</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>          <span class="at">newdata =</span> X_test_selected_std,</span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>          <span class="at">type    =</span> <span class="st">"lp"</span>,</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>          <span class="at">at.step =</span> optimal_steps)</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Split test data into high/low risk groups using median cutoff</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>risk_groups <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(risk_scores_test <span class="sc">&gt;</span> <span class="fu">median</span>(risk_scores_test), <span class="st">"High"</span>, <span class="st">"Low"</span>)</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>risk_groups <span class="ot">&lt;-</span> <span class="fu">factor</span>(risk_groups, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"High"</span>))</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Create actual status for comparison</span></span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>actual_is_dead <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(test_is_dead <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"High"</span>, <span class="st">"Low"</span>),</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"High"</span>)</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate C-index</span></span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>c_index <span class="ot">&lt;-</span> <span class="fu">rcorr.cens</span>(<span class="sc">-</span>risk_scores_test, <span class="fu">Surv</span>(test_time, test_is_dead))[<span class="dv">1</span>]</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate confusion matrix</span></span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>cm_caret <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> risk_groups,</span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>  <span class="at">reference =</span> actual_is_dead,</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>  <span class="at">positive =</span> <span class="st">"High"</span></span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>prepare_survival_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> test_time,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> test_is_dead,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk_group =</span> <span class="fu">factor</span>(risk_groups)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>km_data <span class="ot">&lt;-</span> <span class="fu">prepare_survival_data</span>()</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>surv_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> risk_group, <span class="at">data =</span> km_data)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>surv_diff <span class="ot">&lt;-</span> <span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> risk_group, <span class="at">data =</span> km_data)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>p_val <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">pchisq</span>(surv_diff<span class="sc">$</span>chisq, <span class="at">df =</span> <span class="fu">length</span>(surv_diff<span class="sc">$</span>n) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>p_text <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(p_val <span class="sc">&lt;</span> <span class="fl">0.001</span>, <span class="st">"p &lt; 0.001"</span>, <span class="fu">paste</span>(<span class="st">"p ="</span>, <span class="fu">round</span>(p_val, <span class="dv">3</span>)))</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  surv_fit, <span class="at">data =</span> km_data,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">pval =</span> p_text, <span class="at">risk.table =</span> <span class="cn">FALSE</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#2E9FDF"</span>, <span class="st">"#E7B800"</span>),</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time (months)"</span>, <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Survival by Predicted Risk Group"</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"Low Risk"</span>, <span class="st">"High Risk"</span>),</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"Risk Group"</span>,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_bw</span>(), <span class="at">conf.int =</span> <span class="cn">TRUE</span>,</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">censor.shape =</span> <span class="st">"+"</span>, <span class="at">censor.size =</span> <span class="dv">4</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Biomed8Report_files/figure-html/results_km-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for time-dependent AUC plot</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>prepare_time_auc_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(test_is_dead <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> test_time</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  marker <span class="ot">&lt;-</span> risk_scores_test</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  n_event <span class="ot">&lt;-</span> <span class="fu">sum</span>(delta <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  n_cens <span class="ot">&lt;-</span> <span class="fu">sum</span>(delta <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n_event <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> n_cens <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  eval_times2 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">6</span>, <span class="fu">floor</span>(<span class="fu">max</span>(T)), <span class="at">by =</span> <span class="dv">6</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  eval_times2 <span class="ot">&lt;-</span> eval_times2[<span class="fu">sapply</span>(eval_times2, <span class="cf">function</span>(t)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">any</span>(delta <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> T <span class="sc">&lt;=</span> t) <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(delta <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> T <span class="sc">&gt;=</span> t))]</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(eval_times2) <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  td <span class="ot">&lt;-</span> timeROC<span class="sc">::</span><span class="fu">timeROC</span>(T, delta, <span class="fu">as.numeric</span>(marker), <span class="at">cause =</span> <span class="dv">1</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>                         <span class="at">times =</span> eval_times2, <span class="at">iid =</span> <span class="cn">TRUE</span>,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>                         <span class="at">weighting =</span> <span class="st">"marginal"</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  auc_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> td<span class="sc">$</span>times,</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">auc =</span> td<span class="sc">$</span>AUC,</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">se =</span> td<span class="sc">$</span>inference<span class="sc">$</span>vect_sd_1</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  auc_df<span class="sc">$</span>lower <span class="ot">&lt;-</span> <span class="fu">pmax</span>(auc_df<span class="sc">$</span>auc <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> auc_df<span class="sc">$</span>se, <span class="dv">0</span>)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  auc_df<span class="sc">$</span>upper <span class="ot">&lt;-</span> <span class="fu">pmin</span>(auc_df<span class="sc">$</span>auc <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> auc_df<span class="sc">$</span>se, <span class="dv">1</span>)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  auc_df<span class="sc">$</span>eval_times <span class="ot">&lt;-</span> eval_times2</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(auc_df)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">prepare_time_auc_data</span>()</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(time, auc)) <span class="sc">+</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">colour =</span> <span class="st">"#2E9FDF"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">fill =</span> <span class="st">"#2E9FDF"</span>, <span class="at">alpha =</span> .<span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> .<span class="dv">5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">colour =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> plot_data<span class="sc">$</span>eval_times) <span class="sc">+</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Time-dependent AUC (Test Set)"</span>,</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Months Since Diagnosis"</span>, <span class="at">y =</span> <span class="st">"AUC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Biomed8Report_files/figure-html/results_time_auc-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to calculate Brier score</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>calculate_brier_score <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define evaluation times for Brier score</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  eval_times <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">6</span>, <span class="fu">floor</span>(<span class="fu">max</span>(test_time)), <span class="at">by =</span> <span class="dv">6</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  eval_times <span class="ot">&lt;-</span> eval_times[<span class="fu">sapply</span>(eval_times, <span class="cf">function</span>(t)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">any</span>(test_is_dead <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> test_time <span class="sc">&lt;=</span> t) <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(test_time <span class="sc">&gt;=</span> t))]</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare test data for Score function</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  test_score_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">time    =</span> test_time,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_dead =</span> test_is_dead,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>(X_test_selected_std)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate Brier score with error handling</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  score_res <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    riskRegression<span class="sc">::</span><span class="fu">Score</span>(</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">object       =</span> <span class="fu">list</span>(<span class="at">CoxBoost =</span> coxboost_model),</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula      =</span> <span class="fu">Surv</span>(time, is_dead) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">data         =</span> test_score_df,</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">times        =</span> eval_times,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics      =</span> <span class="st">"brier"</span>,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">cens.model   =</span> <span class="st">"km"</span>,</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">split.method =</span> <span class="st">"none"</span>,</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">summary      =</span> <span class="st">"ibs"</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) e)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process results</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(score_res, <span class="st">"error"</span>) <span class="sc">||</span> <span class="fu">length</span>(eval_times) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Brier-score computation failed: "</span>,</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">inherits</span>(score_res, <span class="st">"error"</span>)) score_res<span class="sc">$</span>message <span class="cf">else</span> <span class="st">"no eval times"</span>)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    brier_df  <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    ibs_value <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    brier_df <span class="ot">&lt;-</span> score_res<span class="sc">$</span>Brier<span class="sc">$</span>score[score_res<span class="sc">$</span>Brier<span class="sc">$</span>score<span class="sc">$</span>model <span class="sc">==</span> <span class="st">"CoxBoost"</span>, <span class="fu">c</span>(<span class="st">"times"</span>, <span class="st">"Brier"</span>)]</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(brier_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"time"</span>, <span class="st">"brier"</span>)</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    ibs_value <span class="ot">&lt;-</span> score_res<span class="sc">$</span>Brier<span class="sc">$</span>score[model <span class="sc">==</span> <span class="st">"CoxBoost"</span> <span class="sc">&amp;</span> times <span class="sc">==</span> <span class="fu">max</span>(times), IBS]</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">brier_df =</span> brier_df, <span class="at">ibs_value =</span> ibs_value, <span class="at">eval_times =</span> eval_times))</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>brier_results <span class="ot">&lt;-</span> <span class="fu">calculate_brier_score</span>()</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>brier_df <span class="ot">&lt;-</span> brier_results<span class="sc">$</span>brier_df</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(brier_df, <span class="fu">aes</span>(time, brier)) <span class="sc">+</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">colour =</span> <span class="st">"#2E9FDF"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> .<span class="dv">25</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">colour =</span> <span class="st">"grey60"</span>) <span class="sc">+</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> brier_df<span class="sc">$</span>time) <span class="sc">+</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Time-dependent Brier Score (Test Set)"</span>,</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Months Since Diagnosis"</span>, <span class="at">y =</span> <span class="st">"Brier Score"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Biomed8Report_files/figure-html/results_brier-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"IBS: "</span>, brier_results<span class="sc">$</span>ibs_value, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"C-Index: "</span>, c_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Optimal Boosting Steps: "</span>, optimal_steps, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IBS:  0.1444313 
 C-Index:  0.7218543 
 Optimal Boosting Steps:  7 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>extract_gene_symbol <span class="ot">&lt;-</span> <span class="cf">function</span>(gene_assignment) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  parts <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(gene_assignment, <span class="st">" // "</span>)[[<span class="dv">1</span>]]</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(parts) <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="fu">return</span>(<span class="fu">trimws</span>(parts[<span class="dv">2</span>])) <span class="cf">else</span> <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">&lt;-</span> <span class="fu">coef</span>(coxboost_model)[selected_features]</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>coef_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature =</span> selected_features,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">coefficient =</span> coefs,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">original_id =</span> lookup<span class="sc">$</span>raw[<span class="fu">match</span>(feature, lookup<span class="sc">$</span>safe)],</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_info =</span> GSE28735<span class="sc">$</span>featureData<span class="sc">$</span>gene_assignment[<span class="fu">match</span>(original_id, <span class="fu">rownames</span>(GSE28735<span class="sc">$</span>featureData))],</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_symbol =</span> <span class="fu">sapply</span>(gene_info, extract_gene_symbol, <span class="at">USE.NAMES =</span> <span class="cn">FALSE</span>),</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">display_name =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(gene_symbol), </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">paste0</span>(gene_symbol, <span class="st">" ("</span>, feature, <span class="st">")"</span>), </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>                          feature),</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">impact =</span> <span class="fu">ifelse</span>(coefficient <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Risk (Worse Survival)"</span>, <span class="st">"Protective (Better Survival)"</span>),</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_coef =</span> <span class="fu">abs</span>(coefficient)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(abs_coef))</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(coef_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(display_name, abs_coef), <span class="at">y =</span> coefficient, <span class="at">fill =</span> impact)) <span class="sc">+</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Protective (Better Survival)"</span> <span class="ot">=</span> <span class="st">"#2E9FDF"</span>, </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Risk (Worse Survival)"</span> <span class="ot">=</span> <span class="st">"#E7B800"</span>)) <span class="sc">+</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Feature Importance in CoxBoost Survival Model"</span>,</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Top genes ranked by effect size"</span>,</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Coefficient"</span>,</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Impact"</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Biomed8Report_files/figure-html/results_feature_importance-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>