---
title: "EDA and Models"
author: "Biomed8"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    number_sections: yes
    self_contained: yes
    theme: flatly
    css: 
      - https://use.fontawesome.com/releases/v5.0.6/css/all.css
    toc: true
    toc_depth: 3
    toc_float: true
    code_folding: show
---
This version includes the data processing and the complete Cox model.
```{r SETUP, warning=FALSE, message=FALSE}
library(GEOquery)
library(limma)
library(ggplot2)
library(pheatmap)
library(RColorBrewer)
library(reshape2)
library(ggfortify)
library(knitr)
library(tidyverse)
library(dplyr)
library(survival)
library(glmnet)
library(survminer)
library(caret)
```

# Load Data and data processing

```{r GET_DATA, warning=FALSE, message=FALSE}

extract_gene_symbol <- function(gene_assignment) {
  # Split the string by //
  parts <- strsplit(gene_assignment, " // ")[[1]]
  
  # Return the second element (gene symbol)
  if (length(parts) >= 2) {
    return(trimws(parts[2]))
  } else {
    return(NA)
  }
}

extract_gse_data <- function(gse) {
  # filteredFeatureData <- fData(gse) %>% filter(gene_assignment != "---")
  # filteredFeatureData$gene_symbol <- sapply(filteredFeatureData$gene_assignment, extract_gene_symbol)
  return(list(
    featureData = fData(gse),
    phenoData = pData(gse),
    eMat = exprs(gse)
  ))
}

GSE78229 <- getGEO("GSE78229")$GSE78229_series_matrix.txt.gz %>% extract_gse_data()
GSE28735 <- getGEO("GSE28735")$GSE28735_series_matrix.txt.gz %>% extract_gse_data()
GSE62452 <- getGEO("GSE62452")$GSE62452_series_matrix.txt.gz %>% extract_gse_data()

```


```{r COMBINE_EMAT}
find_common_genes <- function(...) {
  matrices <- list(...)
  common_genes <- Reduce(intersect, lapply(matrices, rownames))
  return(common_genes)
}

common_genes <- find_common_genes(GSE28735$eMat, GSE62452$eMat)

# subset_eMat_GSE78229 <- GSE78229$eMat[common_genes, ]
subset_eMat_GSE28735 <- GSE28735$eMat[common_genes, ]
subset_eMat_GSE62452 <- GSE62452$eMat[common_genes, ]

#combined_matrix <- cbind(subset_eMat_GSE78229, subset_eMat_GSE28735, subset_eMat_GSE62452)

combined_matrix <- cbind(subset_eMat_GSE28735, subset_eMat_GSE62452)

# print(dim(combined_matrix))
```

```{r FILTER_28735_PHENO}

GSE28735$phenoData$is_dead <- as.numeric(
  replace(
    GSE28735$phenoData$`cancer_death:ch1`, 
    GSE28735$phenoData$`cancer_death:ch1` == "na", NA
    )
  )

non_tumor_rows <- grepl("non-tumor tissue", GSE28735$phenoData$`source_name_ch1`)

filtered_tumor <- GSE28735$phenoData[!non_tumor_rows, ]

filtered_28735 <- filtered_tumor[!is.na(filtered_tumor$is_dead), ] %>% rename(months_survived = `survival_month:ch1`)

# nrow(filtered_28735)
```

```{r FILTER_62452_PHENO}
GSE62452$phenoData$is_dead <- as.numeric(
  replace(
    GSE62452$phenoData$`survival status:ch1`,
    GSE62452$phenoData$`survival status:ch1` %in% c("na", "?"), NA
    )
  )

tumor_rows <- grepl("Pancreatic tumor", GSE62452$phenoData$`tissue:ch1`)

filtered_tumor <- GSE62452$phenoData[tumor_rows, ]

filtered_62452 <- filtered_tumor[!is.na(filtered_tumor$is_dead), ] %>%
  rename(months_survived = `survival months:ch1`)

# nrow(filtered_62452)
```

```{r COMBINE_PHENO_DATA}

combined_pheno <- bind_rows(filtered_28735, filtered_62452)
filtered_matrix <- combined_matrix[, colnames(combined_matrix) %in% rownames(combined_pheno)]

# dim(filtered_matrix)

gse <- list(
  featureData = GSE28735$featureData,
  phenoData = combined_pheno,
  eMat = filtered_matrix
)
```

# Exploratory Data Analysis (EDA)
## Distribution of Expression Values in Combined Dataset
### 2.1 Overview + Histogram

```{r CREATE_EDA_SET}

# Combine pheno data
eda_pheno <- bind_rows(GSE28735$phenoData, GSE62452$phenoData)
eda_matrix <- combined_matrix[, colnames(combined_matrix) %in% rownames(eda_pheno)]
stopifnot(all(colnames(eda_matrix) == rownames(eda_pheno)))

gse_eda <- list(
  featureData = GSE28735$featureData,
  phenoData = eda_pheno,
  eMat = eda_matrix
)
```

### Distribution of Expression Values (Tumor + Non-Tumor)

```{r}
dim(gse_eda$eMat)
summary_values_eda <- summary(as.vector(gse_eda$eMat))
hist(gse_eda$eMat, breaks = 100, main = "All Samples Expression Histogram", xlab = "Expression", col = "lightblue")
```

### Summary Table (Per Sample)

```{r}
summary_per_sample_eda <- as.data.frame(t(apply(gse_eda$eMat, 2, summary)))
summary_per_sample_eda$SampleID <- rownames(summary_per_sample_eda)
summary_per_sample_eda <- summary_per_sample_eda %>%
  relocate(SampleID) %>%
  rename(
    Min = "Min.",
    Q1 = "1st Qu.",
    Median = "Median",
    Mean = "Mean",
    Q3 = "3rd Qu.",
    Max = "Max."
  )

kable(head(summary_per_sample_eda), caption = "Summary Statistics (All Samples)")
```

### Boxplots

```{r}
summary_long_eda <- summary_per_sample_eda %>%
  pivot_longer(cols = -SampleID, names_to = "Statistic", values_to = "Value")

ggplot(summary_long_eda, aes(x = Statistic, y = Value)) +
  geom_boxplot(fill = "skyblue") +
  facet_wrap(~ Statistic, scales = "free") +
  ggtitle("Summary Statistics Boxplot (All Samples)") +
  theme_minimal()

boxplot(gse_eda$eMat, outline = FALSE, las = 2, main = "Expression per Sample (All)", col = "gray90")
```

## PCA Plot (Tumor + Non-Tumor)

```{r}
gse_eda$phenoData$Tissue <- ifelse(grepl("non-tumor|normal", gse_eda$phenoData$`source_name_ch1`, ignore.case = TRUE),
                                   "Normal", "Tumor")
gse_eda$phenoData$Tissue <- factor(gse_eda$phenoData$Tissue)

pca_all <- prcomp(t(gse_eda$eMat), scale. = TRUE)

autoplot(pca_all, data = gse_eda$phenoData, colour = "Tissue") +
  ggtitle("PCA: Tumor vs Normal Samples") +
  theme_minimal()
```

## Heatmap (Top 100 Variable Genes)

```{r}
var_genes_eda <- apply(gse_eda$eMat, 1, var)
top100_genes_eda <- names(sort(var_genes_eda, decreasing = TRUE)[1:100])

annotation_col_eda <- data.frame(Tissue = gse_eda$phenoData$Tissue)
rownames(annotation_col_eda) <- rownames(gse_eda$phenoData)

pheatmap(gse_eda$eMat[top100_genes_eda, ],
         scale = "row",
         show_rownames = FALSE,
         show_colnames = FALSE,
         annotation_col = annotation_col_eda,
         main = "Top 100 Variable Genes - All Samples")
```

# Cox Model

## Choose λ 

```{r}
# Construct survival object: assume that 'months_survived' in gse$phenoData is the survival time (numeric) and 'is_dead' is the event status (1 = death, 0 = survival)
surv_obj <- with(gse$phenoData, Surv(as.numeric(months_survived), as.numeric(is_dead)))

## Penalized Cox Model
# Build the prediction model using all 28869 genes 
# Prepare the prediction matrix x: the columns in gse$eMat represent samples; after transposition, rows represent samples and columns represent features
x <- t(gse$eMat)
x <- as.matrix(x)

# Fit the Cox model with Lasso penalty using cross-validation
set.seed(3888)
cvfit <- cv.glmnet(x, surv_obj, family = "cox", alpha = 1)
plot(cvfit, main = "Cross-validation for Penalized Cox Model")
best_lambda <- cvfit$lambda.min
```


Horizontal axis: Log(λ). When λ gets larger (to the left), the penalty becomes stronger and the model becomes more sparse. When λ gets smaller (to the right), the penalty becomes weaker and more genes are kept.

Vertical axis: Partial Likelihood Deviance. A smaller value means the model fits better.

Each red dot shows the average deviance for a λ value. The gray lines show the range of error across different folds.

The left dashed line shows λ.min, where the error is the smallest and the model fits the best.

The right dashed line shows λ.1se, which gives a slightly stronger penalty. It makes the model simpler and uses fewer genes.

We chose the λ.min on the left dashed line, which is 0.2227.

```{r}
cat("Best lambda:", best_lambda, "\n")
```

Through model calculation, the optimal λ value is 0.256105. This is the best choice for the Lasso penalty strength. Under this penalty, the model automatically shrinks the coefficients of many genes to zero, keeping only a small number of genes that are significantly related to survival.

## Build Cox model and visualization
```{r}
# Fit the final model using the optimal lambda
final_model <- glmnet(x, surv_obj, family = "cox", alpha = 1, lambda = best_lambda)
coef_final <- coef(final_model)

cat("Non-zero coefficients in the final model:\n")
nz_idx <- which(coef_final != 0)
df <- data.frame(gene_id = colnames(x)[nz_idx],
  coef    = as.numeric(coef_final[nz_idx]))
print(df)
```

After training the model, a total of 22 genes were selected.

The absolute value of each gene's coefficient reflects its contribution to the risk score: the larger the absolute value, the higher the weight of the gene in the model and the more important it is for distinguishing prognosis.

This can be seen more clearly in the figure.
```{r}
library(ggplot2)
ggplot(df, aes(x = reorder(gene_id, coef), y = coef, fill = coef > 0)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("red","blue"), labels = c("high-risk gene","protective gene")) +
  labs(x = NULL, y = "coef", title = "Lasso-Cox gene id") +
  theme_minimal()

```


A positive coefficient means that higher expression of the gene is associated with a higher risk of death, indicating a high-risk gene. This suggests that the gene may be promoting disease progression.

A negative coefficient means that higher expression of the gene is associated with a lower risk of death, indicating a protective gene. These genes may help slow down disease progression.

## Result visualization

```{r}
# Compute the risk scores for each sample (linear predictor)
risk_scores <- predict(final_model, newx = x, type = "link")
# Divide the samples into high-risk and low-risk groups by using the median risk score as the cutoff
risk_group <- ifelse(risk_scores > median(risk_scores), "High", "Low")

# Add the risk group information to the original phenotype data
gse$phenoData$risk_group <- factor(risk_group, levels = c("Low", "High"))

# Use the Kaplan-Meier method to compare the survival curves of the two risk groups
fit_km <- survfit(surv_obj ~ risk_group, data = gse$phenoData)
ggsurvplot(fit_km, data = gse$phenoData, pval = TRUE, risk.table = TRUE, 
           title = "Kaplan-Meier Survival Curves by Risk Group")
```


Risk grouping: Patients were divided into "low-risk group" (red) and "high-risk group" (cyan) based on the median risk score of all samples.

Kaplan–Meier curve: The horizontal axis shows follow-up time (months), and the vertical axis shows survival probability.

The red curve stays above the cyan curve at all times, indicating that patients in the low-risk group have a much higher survival rate compared to those in the high-risk group.

Log-rank test p-value: p < 0.0001, showing that the difference between the two survival curves is statistically highly significant. This means that the risk score based on the 29 selected genes can clearly distinguish between good and poor prognosis.

Risk table (Number at risk): Shown below the curves, it displays the number of patients still under follow-up at each time point, helping to evaluate the reliability of survival estimates in later stages.

## RF 

```{r MDRF_FEATURE_SELECTION}
library(randomForestSRC)

gse$phenoData$months_survived <- as.factor(gse$phenoData$months_survived)

  
# Expression matrix: genes as columns, samples as rows
expr_df <- as.data.frame(t(gse$eMat))
expr_df$sample_id <- rownames(expr_df)

# Phenotype data
pheno <- gse$phenoData
pheno$sample_id <- rownames(pheno)

# Merge to create the full dataset
merged_data <- merge(expr_df, pheno[, c("sample_id", "months_survived", "is_dead")], by = "sample_id")
merged_data$sample_id <- NULL

# Run survival forest model
set.seed(42)
rf_model <- rfsrc(Surv(months_survived, is_dead) ~ ., data = merged_data, ntree = 500, forest = TRUE)

# Compute minimum depth of each variable
md_info <- max.subtree(rf_model)$order[, 1]  # gives a named vector: variable -> depth

# Sort and select top genes (e.g., top 50)
top_genes <- names(sort(md_info))[1:50]

```


```{r VISUALISE_FS}

# Sort and make a dataframe
md_df <- data.frame(
  gene = names(md_info),
  depth = as.numeric(md_info)
)
top_md_df <- md_df[order(md_df$depth), ][1:30, ]

# Barplot
library(ggplot2)

ggplot(top_md_df, aes(x = reorder(gene, -depth), y = depth)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = "Top Genes by Minimum Depth",
       x = "Gene", y = "Minimum Depth")


```
```{r}
library("survival")
library("survminer")
# Transpose expression matrix: samples as rows
expr_data <- as.data.frame(t(gse$eMat[top_genes, ]))

dim(expr_data)

# Add survival info
expr_data$time <- as.numeric(gse$phenoData$months_survived)
expr_data$status <- as.numeric(gse$phenoData$is_dead)

# Sanitize column names (recommended)
colnames(expr_data) <- make.names(colnames(expr_data))

# Also sanitize your gene list accordingly
top_genes_clean <- make.names(top_genes)

# Build formula again with cleaned names
cox_formula <- as.formula(paste("Surv(time, status) ~", paste(top_genes_clean, collapse = " + ")))

# Fit the model
cox_model <- coxph(cox_formula, data = expr_data)

# Summary of results
summary(cox_model)

ggforest(cox_model, data = expr_data, 
         main = "Hazard Ratios for Top Genes",
         cpositions = c(0.02, 0.22, 0.4))

```
```{r}
library(devtools)
install_github("binderh/CoxBoost")
library(CoxBoost)

time <- expr_data$time
status <- expr_data$status
gene_data <- expr_data[, -c(which(names(expr_data) %in% c("time", "status")))]

set.seed(3888) 
coxboost_model <- CoxBoost(time = time, status = status, x = as.matrix(gene_data), stepno = 100)

summary(coxboost_model)

plot(coxboost_model)

coefficients <- coef(coxboost_model)
print(coefficients)
```
```{r}
# Load necessary libraries
library(CoxBoost)
library(survival)
library(survminer)

# Assuming expr_data is your dataset with survival information and gene expression data
# expr_data$time: survival time
# expr_data$status: event status (1 if event occurred, 0 otherwise)
# expr_data: gene expression data

# Prepare the data
time <- expr_data$time
status <- expr_data$status
gene_data <- expr_data[, -c(which(names(expr_data) %in% c("time", "status")))]

# Fit the CoxBoost model
set.seed(123) # For reproducibility
coxboost_model <- CoxBoost(time = time, status = status, x = as.matrix(gene_data), stepno = 100)

# Create a survival object
surv_obj <- Surv(time, status)

# Fit a baseline survival curve
base_coxph <- coxph(surv_obj ~ 1)  # Fit a null model
base_surv <- survfit(base_coxph)

# Predict the linear predictor
lp <- predict(coxboost_model, newdata = as.matrix(gene_data), type = "lp")

# Calculate survival probabilities for each individual
surv_probs <- sapply(1:nrow(gene_data), function(i) {
  base_surv$surv ^ exp(lp[i])
})

# Plot the average survival curve
avg_surv_probs <- rowMeans(surv_probs)

plot(base_surv$time, avg_surv_probs, type = "l", col = "blue",
     xlab = "Time", ylab = "Probability of Survival",
     main = "Average Survival Probability Over Time")
```
