---
title: "pancreatic_cancer"
format: html
editor: visual
---

```{r SETUP, echo=FALSE}

library(GEOquery) 
library(tidyr)
```

```{r GET_DATA, echo=FALSE}

extract_gene_symbol <- function(gene_assignment) {
  # Split the string by //
  parts <- strsplit(gene_assignment, " // ")[[1]]
  
  # Return the second element (gene symbol)
  if (length(parts) >= 2) {
    return(trimws(parts[2]))
  } else {
    return(NA)
  }
}

extract_gse_data <- function(gse) {
  # filteredFeatureData <- fData(gse) %>% filter(gene_assignment != "---")
  # filteredFeatureData$gene_symbol <- sapply(filteredFeatureData$gene_assignment, extract_gene_symbol)
  return(list(
    featureData = fData(gse),
    phenoData = pData(gse),
    eMat = exprs(gse)
  ))
}

GSE78229 <- getGEO("GSE78229")$GSE78229_series_matrix.txt.gz %>% extract_gse_data()
GSE28735 <- getGEO("GSE28735")$GSE28735_series_matrix.txt.gz %>% extract_gse_data()
GSE62452 <- getGEO("GSE62452")$GSE62452_series_matrix.txt.gz %>% extract_gse_data()


```

```{r GENE_INTERSECTION}
find_shared_and_unique_genes <- function(gse1, gse2) {
  genes1 <- rownames(gse1$eMat)
  genes2 <- rownames(gse2$eMat)
  
  shared_genes <- intersect(genes1, genes2)
  
  unique_genes_1 <- setdiff(genes1, genes2)
  unique_genes_2 <- setdiff(genes2, genes1)
  
   return(list(
    size_dif = length(genes1) - length(genes2),
    shared_genes_count = length(shared_genes),
    shared_genes = shared_genes,
    unique_1 = unique_genes_1,
    unique_2 = unique_genes_2
  )) 
}

result_GSE78229_GSE28735 <- find_shared_and_unique_genes(GSE78229, GSE28735)
result_GSE78229_GSE62452 <- find_shared_and_unique_genes(GSE78229, GSE62452)
result_GSE28735_GSE62452 <- find_shared_and_unique_genes(GSE28735, GSE62452)

print(dim(GSE78229$eMat))
print(dim(GSE62452$eMat))
print(dim(GSE28735$eMat))
```

```{r COMBINE_EMAT}
find_common_genes <- function(...) {
  matrices <- list(...)
  common_genes <- Reduce(intersect, lapply(matrices, rownames))
  return(common_genes)
}

common_genes <- find_common_genes(GSE28735$eMat, GSE62452$eMat)

# subset_eMat_GSE78229 <- GSE78229$eMat[common_genes, ]
subset_eMat_GSE28735 <- GSE28735$eMat[common_genes, ]
subset_eMat_GSE62452 <- GSE62452$eMat[common_genes, ]

#combined_matrix <- cbind(subset_eMat_GSE78229, subset_eMat_GSE28735, subset_eMat_GSE62452)

combined_matrix <- cbind(subset_eMat_GSE28735, subset_eMat_GSE62452)

print(dim(combined_matrix))
```

```{r FILTER_28735_PHENO}

GSE28735$phenoData$is_dead <- as.numeric(
  replace(
    GSE28735$phenoData$`cancer_death:ch1`, 
    GSE28735$phenoData$`cancer_death:ch1` == "na", NA
    )
  )

non_tumor_rows <- grepl("non-tumor tissue", GSE28735$phenoData$`source_name_ch1`)

filtered_tumor <- GSE28735$phenoData[!non_tumor_rows, ]

filtered_28735 <- filtered_tumor[!is.na(filtered_tumor$is_dead), ] %>% rename(months_survived = `survival_month:ch1`)

nrow(filtered_28735)
```

```{r FILTER_62452_PHENO}
GSE62452$phenoData$is_dead <- as.numeric(
  replace(
    GSE62452$phenoData$`survival status:ch1`,
    GSE62452$phenoData$`survival status:ch1` %in% c("na", "?"), NA
    )
  )

tumor_rows <- grepl("Pancreatic tumor", GSE62452$phenoData$`tissue:ch1`)

filtered_tumor <- GSE62452$phenoData[tumor_rows, ]

filtered_62452 <- filtered_tumor[!is.na(filtered_tumor$is_dead), ] %>%
  rename(months_survived = `survival months:ch1`)

nrow(filtered_62452)
```

```{r COMBINE_PHENO_DATA}
library(dplyr)

combined_pheno <- bind_rows(filtered_28735, filtered_62452)
filtered_matrix <- combined_matrix[, colnames(combined_matrix) %in% rownames(combined_pheno)]

dim(filtered_matrix)

gse <- list(
  featureData = GSE28735$featureData,
  phenoData = combined_pheno,
  eMat = filtered_matrix
)
```

```{r LINEAR_REGRESSION}
library(caret)

set.seed(3888)

n_samples <- nrow(gse$phenoData)

train_indices <- createDataPartition(gse$phenoData$months_survived, p = 0.8, list = FALSE)
train_data <- gse$phenoData[train_indices, ]
train_eMat <- gse$eMat[, train_indices]

validation_data <- gse$phenoData[-train_indices, ]
validation_eMat <- gse$eMat[, -train_indices]

train_df <- data.frame(months_survived = train_data$months_survived, t(train_eMat))

train_control <- trainControl(method = "cv", number = 5)

model <- train(months_survived ~ ., data = train_df, method = "lm", trControl = train_control)

validation_df <- data.frame(t(validation_eMat))

predictions <- predict(model, newdata = validation_df)

rmse <- RMSE(predictions, validation_data$months_survived)
r2 <- R2(predictions, validation_data$months_survived)

# Output the results
cat("Validation RMSE:", rmse, "\n")
cat("Validation R-squared:", r2, "\n")
```

```{r}
library(glmnet)

# Prepare the data for glmnet
x_train <- as.matrix(t(train_eMat))
# Ensure the response variable is numeric
y_train <- as.numeric(train_data$months_survived)

# Ensure the predictor matrix is numeric
x_train <- as.matrix(t(train_eMat))
x_train <- apply(x_train, 2, as.numeric)

# Fit a Lasso model
lasso_model <- cv.glmnet(x_train, y_train, alpha = 1)

# Prepare the validation data
x_validation <- as.matrix(t(validation_eMat))
x_validation <- apply(x_validation, 2, as.numeric)

# Ensure the response variable in the validation set is numeric and has no missing values
observed_values <- as.numeric(validation_data$months_survived)

# Ensure predictions are numeric
predictions <- as.numeric(predict(lasso_model, newx = x_validation, s = "lambda.min"))

# Check the lengths of the vectors
if (length(predictions) != length(observed_values)) {
  stop("The number of predictions does not match the number of observed values.")
}

# Calculate RMSE and R-squared for the validation set
rmse <- RMSE(predictions, observed_values)
r2 <- R2(predictions, observed_values)

# Output the results
cat("Validation RMSE:", rmse, "\n")
cat("Validation R-squared:", r2, "\n")
```
